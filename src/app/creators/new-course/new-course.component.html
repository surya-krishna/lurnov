<div class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-md p-6 text-gray-800">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-semibold">Create New Course</h2>
      <div class="text-sm text-gray-600">Units: {{countUnits()}} / {{maxUnits}}</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Sidebar (moved before main) -->
      <aside class="space-y-4 hidden lg:block">
        <div class="p-4 border rounded-lg bg-gray-50">
          <div class="flex items-center gap-4">
            <div class="w-20 h-12 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
              <img *ngIf="courseInfoComponent?.thumbnailPreview" [src]="courseInfoComponent.thumbnailPreview"
                alt="thumb" class="w-full h-full object-cover" />
            </div>
            <div>
              <div class="font-semibold">{{ course.name || 'Untitled course' }}</div>
              <div class="text-sm text-gray-500">{{ course.description ? (course.description | slice:0:80) +
                (course.description.length>80? '...':'') : 'Add a short description' }}</div>
            </div>
          </div>
        </div>

        <div class="p-4 border rounded-lg bg-white">
          <div *ngIf="loading" class="flex items-center gap-2 text-sm text-gray-700">Loading... <svg
              class="w-4 h-4 animate-spin" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none">
              </circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg></div>
          <div *ngIf="!loading && actionMessage" class="text-sm text-gray-700">{{ actionMessage }}</div>
          <div *ngIf="!loading && !actionMessage" class="text-sm text-gray-500">Progress and server actions show here.
          </div>
        </div>

        <div class="p-4 border rounded-lg bg-white text-sm text-gray-600">
          <div class="font-medium mb-2">Summary</div>
          <div>Subjects: {{ course.subjects?.length || 0 }}</div>
          <div>Units: {{ countUnits() }}</div>
          <div *ngIf="createdCourseId" class="mt-2 text-xs text-green-600">Saved course id: {{ createdCourseId }}</div>
        </div>

        <!-- Test List Sidebar (Only visible in Step 4) -->
        <div *ngIf="step===4" class="p-4 border rounded-lg bg-white text-sm text-gray-600">
          <div class="flex items-center justify-between mb-4">
            <div class="font-medium">Tests</div>
            <div class="relative">
              <button (click)="showNewTestOptions = !showNewTestOptions"
                class="p-1 rounded hover:bg-gray-100 text-indigo-600 font-medium flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                New
              </button>
              <!-- Dropdown -->
              <div *ngIf="showNewTestOptions"
                class="absolute right-0 mt-1 w-48 bg-white rounded-md shadow-lg border z-10 py-1">
                <button (click)="openAutoGenerate()"
                  class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Auto Generate</button>
                <button (click)="createNewTest()"
                  class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Create
                  Manually</button>
              </div>
            </div>
          </div>

          <div class="space-y-2">
            <div *ngFor="let test of tests; let i = index"
              class="p-3 rounded border cursor-pointer hover:border-indigo-300 transition-colors group relative"
              [class.border-indigo-500]="selectedTestId === test.id" [class.bg-indigo-50]="selectedTestId === test.id"
              (click)="selectTest(test.id)">
              <div class="font-medium text-gray-900">{{ test.name || 'Untitled Test' }}</div>
              <div class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                <span class="px-1.5 py-0.5 rounded bg-gray-100">{{ test.type }}</span>
              </div>
              <button (click)="$event.stopPropagation(); deleteTest(i)"
                class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                  </path>
                </svg>
              </button>
            </div>
            <div *ngIf="tests.length === 0" class="text-center py-8 text-gray-400 italic">
              No tests created yet.
            </div>
          </div>
        </div>
      </aside>

      <!-- Left: Form -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Stepper -->
        <div class="flex items-center gap-4 mb-2">
          <ng-container *ngFor="let label of ['Course','Subjects','Chapters', 'Tests', 'Packages']; let idx = index">
            <div class="flex items-center gap-3 group cursor-pointer" (click)="setStep(idx+1)">
              <div class="w-9 h-9 flex items-center justify-center rounded-full font-medium transition-all duration-300"
                [ngClass]="{ 'bg-indigo-600 text-white shadow hover:bg-indigo-700 transition-all duration-200 transform hover:scale-105 shadow-md scale-110': step === (idx+1), 'bg-gray-100 text-gray-700 group-hover:bg-gray-200': step !== (idx+1) }">
                {{ idx+1 }}</div>
              <div class="text-sm font-medium transition-colors duration-300" [class.text-indigo-600]="step === (idx+1)"
                [class.font-bold]="step === (idx+1)">{{ label }}</div>
            </div>
            <div *ngIf="idx < 4" class="flex-1 h-0.5 bg-gray-200"></div>
          </ng-container>
        </div>

        <!-- Course Info -->
        <div *ngIf="step===1">
          <app-course-info [course]="course" [loading]="loading" [courseDirty]="courseDirty"
            (courseChange)="onCourseChange()" (save)="createCourse()" (continue)="createCourse()">
          </app-course-info>
        </div>

        <!-- Subjects -->
        <div *ngIf="step===2">
          <app-subject-manager [course]="course" [loading]="loading" [courseDirty]="courseDirty"
            (save)="onSubjectsSave()" (continue)="onSubjectsContinue()" (back)="prevStep()">
          </app-subject-manager>
        </div>

        <!-- Chapters -->
        <div *ngIf="step===3">
          <app-chapter-manager [course]="course" [loading]="loading" [courseDirty]="courseDirty"
            (save)="onChaptersSave()" (continue)="onChaptersContinue()" (back)="prevStep()">
          </app-chapter-manager>
        </div>

        <!-- Step 4: Tests -->
        <div *ngIf="step===4" class="space-y-4 p-4 border rounded-lg bg-white">
          <h3 class="font-semibold">Tests</h3>
          <div *ngIf="!createdCourseId" class="text-sm text-red-500">Please save the course first.</div>

          <app-test-manager *ngIf="createdCourseId" [courseId]="createdCourseId" [course]="course"></app-test-manager>

          <div class="flex justify-end gap-2 mt-4">
            <button (click)="prevStep()" class="py-2 px-4 rounded border">Back</button>
            <button (click)="nextStep()"
              class="py-2 px-6 rounded bg-indigo-600 text-white shadow hover:bg-indigo-700">Continue</button>
          </div>
        </div>

        <!-- Step 5: Packages -->
        <div *ngIf="step===5" class="space-y-4 p-4 border rounded-lg bg-white">
          <h3 class="font-semibold">Packages</h3>
          <div *ngIf="!createdCourseId" class="text-sm text-red-500">Please save the course first.</div>

          <app-package-manager *ngIf="createdCourseId" [course]="course"></app-package-manager>

          <div class="flex justify-end gap-2 mt-4">
            <button (click)="prevStep()" class="py-2 px-4 rounded border">Back</button>
            <button (click)="submitAll()"
              class="py-2 px-6 rounded bg-green-600 text-white shadow hover:bg-green-700">Finish</button>
          </div>
        </div>

      </div>

      <!-- Mobile sidebar drawer -->
      <div *ngIf="showSidebar" class="fixed inset-0 z-50 lg:hidden">
        <div class="absolute inset-0 bg-black opacity-40" (click)="toggleSidebar()"></div>
        <div class="absolute inset-y-0 left-0 w-72 bg-white p-4 overflow-auto shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <div class="font-semibold">Course</div>
            <button class="px-2 py-1 border rounded" (click)="toggleSidebar()">Close</button>
          </div>
          <div class="space-y-4">
            <div class="p-2 border rounded bg-gray-50">
              <div class="font-semibold">{{ course.name || 'Untitled course' }}</div>
              <div class="text-sm text-gray-500">{{ course.description ? (course.description | slice:0:80) +
                (course.description.length>80? '...':'') : 'Add a short description' }}</div>
            </div>
            <div class="p-2 border rounded bg-white">
              <div *ngIf="actionMessage" class="text-sm text-gray-700">{{ actionMessage }}</div>
              <div *ngIf="!actionMessage" class="text-sm text-gray-500">Progress and server actions show here.</div>
            </div>
            <div class="p-2 border rounded bg-white text-sm text-gray-600">
              <div class="font-medium mb-2">Summary</div>
              <div>Subjects: {{ course.subjects?.length || 0 }}</div>
              <div>Units: {{ countUnits() }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>